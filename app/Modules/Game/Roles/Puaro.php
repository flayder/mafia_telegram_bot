<?php

namespace App\Modules\Game\Roles;

use App\Models\GameUser;
use App\Models\ActiveBaf;
use App\Models\GamerParam;
use App\Modules\Game\Game;
use App\Models\Game as GameModel;
use App\Modules\Bot\AppBot;
use App\Models\NightFunction;
use App\Models\UnionParticipant;

trait Puaro
{
    public static function puaro_check($params)
    { //puaro –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã
        //–ù–∏–∫ - —Ä–æ–ª—å 
        $gamer = GameUser::where('user_id', $params['user_id'])->where('is_active', 1)->first();
        if (!$gamer) return '';
        $checked = GameUser::where('id', $params['cmd_param'])->first();
        //–æ—Ç–ø—Ä–∞–≤–∏–º —Å–æ—é–∑—É, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if($checked)  $result = '<b>üïµüèª‚Äç‚ôÄ–ö–æ–º–∏—Å—Å–∞—Ä –ü—É–∞—Ä–æ</b> –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã ' . $checked->user;
        else $result = 'üïµüèª‚Äç‚ôÄ–ö–æ–º–∏—Å—Å–∞—Ä –ü—É–∞—Ä–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã —É –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞. –í–µ—Ä–æ—è—Ç–Ω–æ –∏–≥—Ä–æ–∫–∞ –∫–∏–∫–Ω—É–ª–∏ –∏–ª–∏ –∏–≥—Ä–æ–∫ –ª–∏–≤–Ω—É–ª';
        $message = ['text' => $result];
        GamerParam::saveParam($gamer, 'puaro_check', $params['cmd_param']);

        $uniPartic = UnionParticipant::where('gamer_id', $gamer->id)->first();
        if ($uniPartic) {
            $participants = UnionParticipant::with('gamer')->where('union_id', $uniPartic->union_id)->get();
            foreach ($participants as $particip) {
                if ($particip->id == $uniPartic->id) continue;
                if (!$particip->gamer->isActive()) continue;
                Game::message(['message' => $message, 'chat_id' => $particip->gamer->user_id]);
            }
        }
        NightFunction::push_func($gamer->game, 'puaro_check_itog',99);
        return '';
    }
    public static function getKomisarPuaro(GameModel $game, string $param) {
        /*
        $puaro = GameUser::where('game_id', $game_id)->where('role_id', 4)->where('is_active',1)->first();
        if(!$puaro) {
            $game = GameModel::where('id',$game_id)->first();
            if($game) {
                $puaro = GameUser::where('game_id', $game_id)->where('role_id', 4)->where('kill_night_number',$game->current_night)->first();
            }
        } */
        $puaro = GamerParam::gamerFromParam($game, $param);
        return $puaro;
    }
    public static function getLiveKomisarPuaro(GameModel $game) {
        return GameUser::where('game_id', $game->id)->where('role_id', 4)->where('first_role_id', '!=', 8)->where('is_active',1)->first();
    }
    public static function puaro_check_itog($game)
    { //puaro –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ã
        //puaro_check
        $puaro = self::getKomisarPuaro($game, 'puaro_check');
        if (!$puaro) return null;
        $gameParams = GamerParam::gameParams($game);
        if (!self::isCanMove($puaro)) {
            // $message = ['text'=>"–°–µ–≥–æ–¥–Ω—è —Ç—ã –ø–æ–¥ —á–∞—Ä–∞–º–∏ üíÉ–ö—Ä–∞—Å–æ—Ç–∫–∏."];
            $check = GamerParam::where('game_id', $game->id)->where('param_name', 'puaro_check')->where('night', $game->current_night)->first();
            if ($check) {
                $check->delete(); //–Ω–µ —É–∑–Ω–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–¥ —á–∞—Ä–∞–º–∏ –∫—Ä–∞—Å–æ—Ç–∫–∏
                GamerParam::saveParam($puaro,'nightactionempty',1);
            }
            // Game::message(['message'=>$message,'chat_id'=>$puaro->user_id]);
        } else {            
            $curCheckGamer = isset($gameParams['puaro_check']) ? GameUser::where('id',$gameParams['puaro_check'])->first() : null;
            if($curCheckGamer) {
                //–ø—Ä–æ–≤–µ—Ä–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ –±–∞—Ñ—ã
                $activeBafs = ActiveBaf::with('baf')->where(['game_id'=>$game->id,'user_id'=>$curCheckGamer->user_id,'is_active'=>1])->get();
                foreach($activeBafs as $activeBaf) {
                    $class = "\\App\\Modules\\Game\\Bafs\\".$activeBaf->baf->baf_class;
                    $actbaf = new $class($activeBaf);
                    $result = $actbaf->puaro_check($curCheckGamer);
                    if($result) {
                        if(isset($result['puaro_view'])) GamerParam::saveParam($curCheckGamer,'puaro_view',$result['puaro_view']);
                        if(isset($result['sleep'])) { //–æ—Ç–ª–æ–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
                            sleep($result['sleep']);
                        }
                        break;
                    }
                }
            }
            $checks = GamerParam::where('game_id', $game->id)->where('param_name', 'puaro_check')->get()->all();
            $gamerIds = array_column($checks, 'param_value');
            $nightOfCheck = [];
            foreach ($checks as $cCheck) {
                $nightOfCheck[$cCheck->param_value] = $cCheck->night;
            }
            $checkGamers = GameUser::with('user')->whereIn('id', $gamerIds)->where('is_active', 1)->get();
            $textArr = [];
            foreach ($checkGamers as $cGamer) {
                $nightParams = GamerParam::gameParams($game, $nightOfCheck[$cGamer->id]);
                if(isset($nightParams['puaro_view'])) { //–ø—Ä–∏–º–µ–Ω–µ–Ω –±–∞—Ñ
                    $textArr[] = Game::userUrlName($cGamer->user) . ' - '.$nightParams['puaro_view'];
                    continue;
                }
                if ($cGamer->role_id == 9) $textArr[] = Game::userUrlName($cGamer->user) . ' -	ü§µüèª –î–æ–Ω –ö–æ—Ä–ª–µ–æ–Ω–µ';
                else if($cGamer->role_id == 23) $textArr[] = Game::userUrlName($cGamer->user) . ' -	üåë –ñ–∏—Ç–µ–ª—å –Ω–æ—á–∏';
                else {                    
                    if (isset($nightParams['advokat_select']) && $nightParams['advokat_select'] == $cGamer->id) {
                        $textArr[] = Game::userUrlName($cGamer->user) . ' - üåë –ñ–∏—Ç–µ–ª—å –Ω–æ—á–∏';
                    } 
                    else if(isset($nightParams['shutnik_puaro'])) {
                        $textArr[] = Game::userUrlName($cGamer->user) . ' - ü§µüèª –î–æ–Ω –ö–æ—Ä–ª–µ–æ–Ω–µ';
                    }
                    else {
                        $textArr[] = Game::userUrlName($cGamer->user) . ' - ' . $cGamer->role;
                    }
                }
            }
            if($curCheckGamer && !$curCheckGamer->isActive()) {
                $textArr[] = Game::userUrlName($curCheckGamer->user) . ' - ' . $curCheckGamer->role;
            }

            $gameParams = GamerParam::gameParams($game);

            $message = ['text' => "<b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</b>\n\n" . implode("\n", $textArr)];
            $uniParticips = UnionParticipant::unionParticipantsByGamer($puaro);
            if ($uniParticips) {
                foreach ($uniParticips as $uParticip) {
                    if ($uParticip->gamer->isActive() || $uParticip->gamer->kill_night_number == $game->current_night) {
                        Game::message(['message' => $message, 'chat_id' => $uParticip->gamer->user_id]);
                        usleep(35000);
                    }
                }
            } else {
                Game::message(['message' => $message, 'chat_id' => $puaro->user_id]);
            }
            if(isset($gameParams['puaro_check'])){
                self::victim_message($gameParams['puaro_check'], 
                $gameParams['puaro_check_result'] ??  'üïµüèª‚Äç‚ôÄ–ö–æ–º–∏—Å—Å–∞—Ä –ü—É–∞—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏–ª –≤–∞—à–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã...');            
            }
        }
    }
    public static function puaro_kill($params)
    {
        $gamer = GameUser::where('user_id', $params['user_id'])->where('is_active', 1)->first();
        if (!$gamer) return '';

        $uniPartic = UnionParticipant::where('gamer_id', $gamer->id)->first();
        $checked = GameUser::where('id', $params['cmd_param'])->first();
        if ($checked && $checked->isActive()) {
            GamerParam::saveParam($gamer, 'puaro_kill', $params['cmd_param']);
            NightFunction::push_func($gamer->game, 'puaro_kill_itog');
        }
        if ($uniPartic) {
            if ($checked && $checked->isActive()) {
                $result = 'üïµüèª‚Äç‚ôÄ–ö–æ–º–∏—Å—Å–∞—Ä –ü—É–∞—Ä–æ —Ä–µ—à–∏–ª, —á—Ç–æ ' . $checked->user . " –Ω–µ –ø—Ä–æ—Å–Ω—ë—Ç—Å—è —ç—Ç–∏–º —É—Ç—Ä–æ–º...";
                $message = ['text' => $result];
                $participants = UnionParticipant::with('gamer')->where('union_id', $uniPartic->union_id)->get();
                foreach ($participants as $particip) {
                    if ($particip->id == $uniPartic->id) continue;
                    if (!$particip->gamer->isActive()) continue;
                    Game::message(['message' => $message, 'chat_id' => $particip->gamer->user_id]);
                }
            }
        }
        self::execBafMethod($gamer, 'shot');
    }
    public static function puaro_kill_itog($game)
    {
        $puaro = self::getKomisarPuaro($game, 'puaro_kill');
        if (!$puaro || !self::isCanMove($puaro)) return null; //–æ–±–µ–∑–¥–≤–∏–∂–µ–Ω
        $gameParams = GamerParam::gameParams($game);
        if(!isset($gameParams['puaro_kill'])) return null;
        
        $victim = GameUser::where('id', $gameParams['puaro_kill'])->first();
        
        if($victim && $victim->role_id == 23) {
            self::user_kill($puaro->id, $gameParams['puaro_kill']);
        } elseif(!self::isTreated($gameParams['puaro_kill'], $game)) {
            //–µ—Å–ª–∏ –Ω–µ —Å–ø–∞—Å –¥–æ–∫
            self::user_deactivate(['user_id' => $puaro->user_id, 'cmd_param' => $gameParams['puaro_kill']]);
        }  
        else {
            if($gameParams['puaro_kill'] == 23) {
                $text = "–°–µ–≥–æ–¥–Ω—è –≤—ã –ø—ã—Ç–∞–ª–∏—Å—å —Å–æ–≤–µ—Ä—à–∏—Ç—å –ø–æ–∫—É—à–µ–Ω–∏–µ –Ω–∞ <b>ü§µüèª‚Äç‚ôÇ–£–≥–æ–ª–æ–≤–Ω–∏–∫–∞</b>, –æ–¥–Ω–∞–∫–æ –ø–æ–ø—ã—Ç–∫–∞ –Ω–µ —É–≤–µ–Ω—á–∞–ª–∞—Å—å —É—Å–ø–µ—Ö–æ–º";
                $bot = AppBot::appBot();
                $bot->sendAnswer([['text'=>$text]],$puaro->user_id);
            } 
        }      
    }
    public static function ifSergantTop($game) {
        $gameParams = GamerParam::gameParams($game);
        if(isset($gameParams['sergant_top']) && !self::checkIfDublerIsNotChanged($game, 4)) {
            GamerParam::deleteAction($game,'sergant_top');
            $puaro = self::getLiveKomisarPuaro($game);  //—Å–µ—Ä–∂–∞–Ω—Ç —É–∂–µ –∫–æ–º
            if(!$puaro) return null;
            $message = ['text'=>"–¢—ã –ø–æ–≤—ã—à–µ–Ω –¥–æ —Ä–æ–ª–∏ <b>üïµÔ∏è–ö–æ–º–∏—Å—Å–∞—Ä –ü—É–∞—Ä–æ</b>"];
            Game::message(['message'=>$message,'chat_id'=>$puaro->user_id]);
            $group_mes = ['text' => "<b>üëÆüèº–°–µ—Ä–∂–∞–Ω—Ç –ì–∞—Å—Ç–∏–Ω–≥—Å</b> –±—ã–ª –ø–æ–≤—ã—à–µ–Ω –¥–æ <b>üïµüèª‚Äç‚ôÄ–ö–æ–º–∏—Å—Å–∞—Ä –ü—É–∞—Ä–æ</b>"];
            Game::message(['message'=>$group_mes,'chat_id'=>$puaro->game->group_id]);
        }
    }
}
